<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Recommendation Widget</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.css" />
    <style>
        :root {
  --brand-black: #000000;
  --brand-dark-grey: #333333;
  --brand-light-grey: #f5f5f5;
  --brand-white: #ffffff;
  --brand-accent: #00aaff; /* example accent ‚Äî adjust if Step One has a specific accent */
}

/* Base / body */
body {
  background: var(--brand-light-grey);
  color: var(--brand-dark-grey);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans‚Äëserif;
}

h1 {
  color: var(--brand-black);
}

/* Swiper container and slides */
.swiper {
  width: 100%;
  max-width: 1200px;
  height: 550px;
  margin: 0 auto;
  position: relative;
}

.swiper-slide {
  background: var(--brand-white);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.swiper-slide:hover {
  transform: translateY(-4px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

.slide {
  cursor: pointer;
  padding: 24px;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  flex: 1;
}

.slide img {
  width: 100%;
  max-width: 280px;
  height: 280px;
  object-fit: contain;
  margin-bottom: 16px;
}

.slide h3 {
  margin: 0;
  font-size: 18px;
  color: var(--brand-dark-grey);
  font-weight: 600;
  line-height: 1.4;
}

.slide p {
  margin: 0;
  font-size: 13px;
  color: #888;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-weight: 500;
}

.slide .button {
  margin-top: 16px;
  padding: 12px 24px;
  background: var(--brand-black);
  color: var(--brand-white);
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.slide button:hover {
  background: var(--brand-dark-grey);
}

/* Loading & Error States */
.loading-container, .error-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 500px;
  padding: 0 20px;
  text-align: center;
}

.error-icon {
  font-size: 64px;
  color: #e74c3c;
}

.error-title {
  font-size: 24px;
  font-weight: 600;
  color: var(--brand-dark-grey);
  margin: 16px 0 8px;
}

.error-message {
  font-size: 16px;
  color: #666;
}

/* Retry button */
.retry-button {
  margin-top: 16px;
  padding: 12px 32px;
  background: var(--brand-dark-grey);
  color: var(--brand-white);
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s ease;
}

.retry-button:hover {
  background: var(--brand-black);
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
  body { padding: 12px; }
  h1 { font-size: 24px; margin-bottom: 20px; }
  .swiper { height: 480px; }
  .slide { padding: 16px; }
  .slide img { max-width: 220px; height: 220px; }
  .slide h3 { font-size: 16px; }
  .slide p { font-size: 12px; }
  .slide button { padding: 10px 20px; font-size: 13px; }
}

@media (max-width: 480px) {
  .swiper { height: 420px; }
  .slide img { max-width: 180px; height: 180px; }
  .slide h3 { font-size: 15px; }
}

/* Side‚Äëcart carousel styles (matching brand) */
.cart-swiper { width: 100%; height: auto; overflow: hidden;}

.cart-slide {
  background: var(--brand-white);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  cursor: pointer;
  transition: background 0.2s ease;
}

.cart-slide:hover {
  background: #f0f0f0;
}

.cart-slide img {
  width: 100%;
  height: 150px;
  object-fit: contain;
  margin-bottom: 12px;
}

.cart-slide h4 {
  margin: 0 0 8px;
  font-size: 14px;
  font-weight: 600;
  color: var(--brand-dark-grey);
  line-height: 1.3;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.cart-slide p {
  margin: 0 0 12px;
  font-size: 11px;
  color: #888;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.cart-slide button {
  width: 100%;
  padding: 8px 16px;
  background: var(--brand-black);
  color: var(--brand-white);
  border: none;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s ease;
  text-transform: uppercase;
}

.cart-slide button:hover {
  background: var(--brand-dark-grey);
}

.cart-pagination {
  margin-top: 12px !important;
  position: relative !important;
}

.cart-loading { display: flex; justify-content: center; align-items: center; padding: 40px 0; }

.cart-error {
  text-align: center;
  padding: 40px 0;
}

.cart-error p { color: #666; margin-bottom: 12px; }

.retry-small-btn {
  padding: 8px 20px;
  background: var(--brand-dark-grey);
  color: var(--brand-white);
  border: none;
  border-radius: 4px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s ease;
}

.retry-small-btn:hover {
  background: var(--brand-black);
}
    </style>
     
    </style>
</head>

<body>
    <div class="container">
        <h1>Recommended Products</h1>

        <!-- Loading State -->
        <div id="loading" class="loading-container">
            <div class="spinner"></div>
            <div class="loading-text">Loading recommendations...</div>
        </div>

        <!-- Error State (hidden by default) -->
        <div id="error" class="error-container" style="display: none;">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h2 class="error-title">Oops! Something went wrong</h2>
            <p class="error-message">We couldn't load the product recommendations. Please try again.</p>
            <button class="retry-button" onclick="loadProducts()">Retry</button>
        </div>

        <!-- Slider main container (hidden by default) -->
        <div id="swiper-container" class="swiper" style="display: none;">
            <!-- Additional required wrapper -->
            <div class="swiper-wrapper">
                <!-- Slides will be dynamically loaded -->
            </div>
            <!-- If we need pagination -->
            <div class="swiper-pagination"></div>

            <!-- If we need navigation buttons -->
            <div class="swiper-button-prev"></div>
            <div class="swiper-button-next"></div>

            <!-- If we need scrollbar -->
            <div class="swiper-scrollbar"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.js"></script>
    <script>
        const API_URL = 'https://australia-southeast1-stepone-backend.cloudfunctions.net/getProductRecommendations';
        const WIDGET_ID = 'product-recommendations-carousel';

        // Initialize dataLayer if it doesn't exist
        window.dataLayer = window.dataLayer || [];

        // Analytics Tracking Function
        function track(widgetId, eventType, productData) {
            const timestamp = new Date().toISOString();
            const eventData = {
                event: 'product_recommendation',
                widgetId,
                eventType,
                productData,
                timestamp,
                userAgent: navigator.userAgent,
                screenSize: `${window.innerWidth}x${window.innerHeight}`
            };

            // Push to dataLayer for GTM/GA4
            window.dataLayer.push(eventData);

            // Also log to console for debugging
            console.log('üìä Analytics Event:', eventData);
        }

        // Show/Hide UI States
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('error').style.display = 'none';
            document.getElementById('swiper-container').style.display = 'none';
        }

        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'flex';
            document.getElementById('swiper-container').style.display = 'none';
            track(WIDGET_ID, 'error', { message: 'Failed to load products' });
        }

        function showSwiper() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('swiper-container').style.display = 'block';
        }

        // Handle Add to Cart
        function handleAddToCart(product, event) {
            event.stopPropagation();
            track(WIDGET_ID, 'add-to-cart', {
                productId: product.id,
                productTitle: product.title,
                productType: product.product_type,
                handle: product.handle
            });
            alert(`Added "${product.title}" to cart!`);
        }

        // Handle Product Click
        function handleProductClick(product) {
            track(WIDGET_ID, 'product-click', {
                productId: product.id,
                productTitle: product.title,
                productType: product.product_type,
                handle: product.handle
            });
            // In production, navigate to product page
            console.log(`Navigate to product: ${product.handle}`);
        }

        // Load Products Function
        function loadProducts() {
            showLoading();
            track(WIDGET_ID, 'widget-load', { url: API_URL });

            fetch(API_URL)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(products => {
                    if (!products || products.length === 0) {
                        throw new Error('No products returned from API');
                    }

                    const swiperWrapper = document.querySelector('.swiper-wrapper');

                    // Map products to slides
                    swiperWrapper.innerHTML = products.map((product, index) => `
                        <div class="swiper-slide" data-product-id="${product.id}">
                            <div class="slide" onclick='handleProductClick(${JSON.stringify(product).replace(/'/g, "&apos;")})'>
                                <img src="${product.images[0]}"
                                     alt="${product.title}"
                                     onerror="this.src='https://via.placeholder.com/300x300?text=No+Image'">
                                <div class="slide-content">
                                    <h3>${product.title}</h3>
                                    <p>${product.product_type}</p>
                                </div>
                                <button class="button" onclick='handleAddToCart(${JSON.stringify(product).replace(/'/g, "&apos;")}, event)'>
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    `).join('');

                    showSwiper();


                    // Initialize Swiper after slides are rendered
                    const swiper = new Swiper('.swiper', {
                        direction: 'horizontal',
                        loop: true,
                        slidesPerView: 1,
                        spaceBetween: 30,

                        pagination: {
                            el: '.swiper-pagination',
                            clickable: true,
                        },

                        navigation: {
                            nextEl: '.swiper-button-next',
                            prevEl: '.swiper-button-prev',
                        },

                        scrollbar: {
                            el: '.swiper-scrollbar',
                        },

                        breakpoints: {
                            640: {
                                slidesPerView: 2,
                            },
                            1024: {
                                slidesPerView: 3,
                            },
                        },

                        // Analytics tracking for swiper events
                        on: {
                            slideChange: function () {
                                const activeSlide = this.slides[this.activeIndex];
                                const productId = activeSlide?.getAttribute('data-product-id');
                                if (productId) {
                                    track(WIDGET_ID, 'slide-view', {
                                        productId,
                                        slideIndex: this.activeIndex
                                    });
                                }
                            },
                            reachEnd: function () {
                                track(WIDGET_ID, 'carousel-end-reached', {});
                            }
                        }
                    });

                    // Track successful load
                    track(WIDGET_ID, 'products-loaded', {
                        count: products.length,
                        products: products.map(p => ({ id: p.id, title: p.title }))
                    });

                    // Track navigation button clicks
                    document.querySelector('.swiper-button-next').addEventListener('click', () => {
                        track(WIDGET_ID, 'navigation-next', {});
                    });

                    document.querySelector('.swiper-button-prev').addEventListener('click', () => {
                        track(WIDGET_ID, 'navigation-prev', {});
                    });

                    // Track pagination clicks
                    document.querySelectorAll('.swiper-pagination-bullet').forEach((bullet, index) => {
                        bullet.addEventListener('click', () => {
                            track(WIDGET_ID, 'pagination-click', { slideIndex: index });
                        });
                    });
                })
                .catch(error => {
                    console.error('Error fetching products:', error);
                    track(WIDGET_ID, 'api-error', {
                        error: error.message,
                        url: API_URL
                    });
                    showError();
                });
        }

        // ===== SIDE CART CAROUSEL (Second Carousel) =====
        const CART_WIDGET_ID = 'cart-recommendations-carousel';

        function handleCartProductClick(product) {
            track(CART_WIDGET_ID, 'product-click', {
                productId: product.id,
                productTitle: product.title,
                productType: product.product_type,
                handle: product.handle
            });
            console.log(`Navigate to product: ${product.handle}`);
        }

        function handleCartAddToCart(product, event) {
            event.stopPropagation();
            track(CART_WIDGET_ID, 'add-to-cart', {
                productId: product.id,
                productTitle: product.title,
                productType: product.product_type,
                handle: product.handle
            });
            alert(`Added "${product.title}" to cart!`);
        }

        loadProducts();
    </script>


    <script>
        // Initialize third placeholder carousel
        new Swiper('#placeholder-swiper-container', {
            direction: 'horizontal',
            loop: true,
            slidesPerView: 1,
            spaceBetween: 30,

            pagination: {
                el: '#placeholder-swiper-container .swiper-pagination',
                clickable: true,
            },

            navigation: {
                nextEl: '#placeholder-swiper-container .swiper-button-next',
                prevEl: '#placeholder-swiper-container .swiper-button-prev',
            },

            scrollbar: {
                el: '#placeholder-swiper-container .swiper-scrollbar',
            },

            breakpoints: {
                640: {
                    slidesPerView: 2,
                },
                1024: {
                    slidesPerView: 3,
                },
            }
        });
    </script>
</body>

</html>